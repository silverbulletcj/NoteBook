## 第二章 流处理基础

* Dataflow编程概述
  * 在概念上来说，就是数据流是无穷无尽的，需要在数据到达的时候就能够进行处理，而不是等待按批次处理。
  * Dataflow图
    * 在Flink中，数据流是一个以一个或者多个源开始，经过用户定义的操作之后，到达一个或者多个sink状态的有向图。在这有向图中，图中顶点为算子，边表示数据依赖关系。没有输入端的算子为数据源，没有输出端的算子为数据汇；在物理Dataflow中，顶点称为任务
  * 数据并行和任务并行
    * 数据并行：将输入数据分组，让同一操作的多个任务并行执行在不同的数据子集上
    * 任务并行：让不同的算子的任务并行计算
  * 数据交换策略
    * 转发策略：任务发送端到接受端一对一传输；在同一机器上可以避免网络通信
    * 广播策略：会把每个数据项发往下游算子的全部并行任务；将数据复制多份且涉及网络通信
    * 基于键值的策略：根据某一键值属性对数据分区，相同的键值会给同一任务处理
    * 随机策略：将数据均匀分配至算子的所有任务
* 并行流处理
  * 延迟：处理一个事件所需的时间
  * 吞吐：系统每单位时间可以处理多少事件
  * 数据流上的操作
    * 数据接入和数据输出：数据源可以是TCP套接字、文件、kafka主题等，数据汇的写入目标可以是文件、数据库、消息队列或监控接口等
    * 转换操作：分别处理每个事件，对其进行转换得到新的输出流
    * 滚动聚合：根据到来的事件持续更新结果
    * 窗口操作：持续的创建一些称为“桶”的有限事件集合，且允许在有限集上进行计算。
      * 滚动窗口：将事件分配到长度固定且互不重叠的桶中
      * 滑动窗口：将事件分配到大小固定且允许相互重叠的桶中，滑动间隔决定多久生成一个新的桶
      * 会话窗口：根据会话间隔将事件分为不同的会话
* 时间语意
  * 处理时间：当前流处理算子所在机器上的本地时钟时间
  * 事件时间：数据流中事件实际发生的时间，以附加在数据流中的时间戳为依据
  * 水位线：一个全局进度指标，表示确信不会再有延迟事件到来的某个时间点，当一个算子接受到时间为T的水位线，就可以认为不会再接受任何时间戳小于T的事件了
  * 事件的发生顺序十分重要，因此用带有时间戳的事件时间能够处理对事件发生顺序要求严格的数据流
* 状态和一致性模型
  * Flink上的操作是有状态的
  * 为了生成结果，函数会在一段时间或者是基于一定个数的事件来积累状态，有状态的算子需要使用传入的事件和内部状态来计算输出
  * 支持有状态的算子面临的实现上的挑战
    * 状态管理
    * 状态划分
    * 状态恢复
* 任务故障
  * 对于输入流的每个事件，每个任务都要执行的步骤为
    * 接收事件并存在本地缓存
    * 选择性的更新内部状态
    * 产生输出记录
  * 流处理系统通过不同的结果保障来定义故障时的行为

* 结果保障
  * 至多一次：保证每个事件至多被处理一次
  * 至少一次：持久化事件日志会将所有事件写入永久存储；记录确认会将所有事件存在缓冲区中，直到处理管道中所有任务都确认某个事件已经处理完才会将事件丢弃
  * 精确一次：以至少一次保障为前提，每个事件对于内部状态的更新都只有一次。